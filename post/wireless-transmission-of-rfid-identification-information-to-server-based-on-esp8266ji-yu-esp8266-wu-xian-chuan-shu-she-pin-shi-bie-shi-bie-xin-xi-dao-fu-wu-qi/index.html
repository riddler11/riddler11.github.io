<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wireless transmission of RFID identification information to server based on ESP8266.（基于ESP8266无线传输射频识别信息传输到服务器） | Leo&#39;s Blog</title>
<link rel="shortcut icon" href="https://riddler11.github.io/favicon.ico?v=1634185890728">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://riddler11.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="Wireless transmission of RFID identification information to server based on ESP8266.（基于ESP8266无线传输射频识别信息传输到服务器） | Leo&#39;s Blog - Atom Feed" href="https://riddler11.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="This is project I did a long time ago. Because of this project, I learn a lot of things. (Not only academically, but als..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://riddler11.github.io">
  <img class="avatar" src="https://riddler11.github.io/images/avatar.png?v=1634185890728" alt="">
  </a>
  <h1 class="site-title">
    Leo&#39;s Blog
  </h1>
  <p class="site-description">
    It's what you do in the dark, that puts you in the light.
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          Home
        </a>
      
    
      
        <a href="/archives" class="menu">
          Archives
        </a>
      
    
      
        <a href="/tags" class="menu">
          Tags
        </a>
      
    
      
        <a href="/post/about" class="menu">
          about
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              Wireless transmission of RFID identification information to server based on ESP8266.（基于ESP8266无线传输射频识别信息传输到服务器）
            </h2>
            <div class="post-info">
              <span>
                2021-10-13
              </span>
              <span>
                10 min read
              </span>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <h3 id="this-is-project-i-did-a-long-time-ago-because-of-this-project-i-learn-a-lot-of-things-not-only-academically-but-also-the-attitude-of-dealing-with-people">This is project I did a long time ago. Because of this project, I learn a lot of things. (Not only academically, but also the attitude of dealing with people.)</h3>
<p>First, look back the board I designed in the past.</p>
<figure data-type="image" tabindex="1"><img src="https://riddler11.github.io/post-images/1634129991464.png" alt="the board" loading="lazy"></figure>
<p>As we all know practice makes prefect. This is the design when I just learned how to use AD software. Integrated by three modules. Arduino uno, ESP8266 and PN532.</p>
<h3 id="i-use-esp8266-to-wirelessly-transmit-the-information-received-by-pn532">I use ESP8266 to wirelessly transmit the information received by PN532.</h3>
<h2 id="about-esp8266">About ESP8266</h2>
<p>It has three modes</p>
<ol>
<li>STA  (station)</li>
<li>AP    (Access Point)</li>
<li>STA、AP Both</li>
</ol>
<p>The technical part adopts STA mode in this project. Arduino sends AT instruction to initialize the module.<br>
<img src="https://riddler11.github.io/post-images/1634181047220.jpg" alt="ESP8266" loading="lazy"><br>
But how to <strong>connect</strong> with the module.<br>
My method is as follows.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Arduino</th>
<th style="text-align:center">connect</th>
<th style="text-align:center">ESP8266</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">3.3V</td>
<td style="text-align:center">&lt;—&gt;</td>
<td style="text-align:center">VCC</td>
</tr>
<tr>
<td style="text-align:center">GND</td>
<td style="text-align:center">&lt;—&gt;</td>
<td style="text-align:center">GND</td>
</tr>
<tr>
<td style="text-align:center">TXD</td>
<td style="text-align:center">&lt;—&gt;</td>
<td style="text-align:center">RXD</td>
</tr>
<tr>
<td style="text-align:center">RXD</td>
<td style="text-align:center">&lt;—&gt;</td>
<td style="text-align:center">TXD</td>
</tr>
<tr>
<td style="text-align:center">3.3V</td>
<td style="text-align:center">&lt;—&gt;</td>
<td style="text-align:center">CH _PD(I added pull-up resistor 1.5K*3. Add a pull resistor about 10K on the internet.)</td>
</tr>
</tbody>
</table>
<h3 id="on-transmission-communication-of-several-modes-of-pn532">On transmission communication of several modes of PN532.</h3>
<figure data-type="image" tabindex="2"><img src="https://riddler11.github.io/post-images/1634182188847.jpg" alt="modes of PN532" loading="lazy"></figure>
<p>As you can see, there are three modes to transmit messages.<br>
HSU、SPI、I2C.</p>
<p>Used with Arduino UNO:<br>
In HSU mode, the serial port monitor will have no information (inconvenient for debugging).<br>
I have never used I2C mode. So I use SPI mode to implementation.<br>
How to turn on SPI mode? Switch <strong>channel1: OFF, channel2: ON</strong>.</p>
<p>This is the note I wrote before.<br>
<img src="https://riddler11.github.io/post-images/1634182979467.png" alt="Notes made before." loading="lazy"></p>
<p>Module connection</p>
<table>
<thead>
<tr>
<th style="text-align:center">Arduino</th>
<th style="text-align:center">connect</th>
<th style="text-align:center">PN532(SPI mode)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Pin13 or ICSP-3</td>
<td style="text-align:center">&lt;—&gt;</td>
<td style="text-align:center">SCK</td>
</tr>
<tr>
<td style="text-align:center">Pin12 or ICSP-1</td>
<td style="text-align:center">&lt;—&gt;</td>
<td style="text-align:center">MISO</td>
</tr>
<tr>
<td style="text-align:center">Pin12 or ICSP-4</td>
<td style="text-align:center">&lt;—&gt;</td>
<td style="text-align:center">MOSI</td>
</tr>
<tr>
<td style="text-align:center">Pin10</td>
<td style="text-align:center">&lt;—&gt;</td>
<td style="text-align:center">SS</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th style="text-align:center">PN532 Pin</th>
<th style="text-align:center">Description of pin</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">SCK:</td>
<td style="text-align:center">Serial Clock</td>
</tr>
<tr>
<td style="text-align:center">MISO:</td>
<td style="text-align:center">Master Input Slave Output</td>
</tr>
<tr>
<td style="text-align:center">MOSI:</td>
<td style="text-align:center">Master Output Slave Input</td>
</tr>
<tr>
<td style="text-align:center">SS(CS):</td>
<td style="text-align:center">Chip Select</td>
</tr>
</tbody>
</table>
<p>Oh my god. What a terrible design. (This is what I made at that time.)<br>
<img src="https://riddler11.github.io/post-images/1634183636663.png" alt="terrible design" loading="lazy"></p>
<h3 id="hardware-running-process">Hardware running process.</h3>
<ol>
<li>Arduino power-on startup procedure.</li>
<li>Initialize the wireless module, connect the wireless module with the preset WiFi, and then connect the server written in Java through TCP protoco</li>
<li>PN532 starts and waits for the card to be read.</li>
<li>When there is a card on it, send the card ID to the server.</li>
</ol>
<p>Hardware code:</p>
<pre><code>#include &lt;SPI.h&gt;
#include &lt;PN532_SPI.h&gt;
#include &quot;PN532.h&quot;
#include &lt;SoftwareSerial.h&gt;
PN532_SPI pn532spi(SPI, 10);
PN532 nfc(pn532spi);


String setCWMODE = &quot;AT+CWMODE=1\r\n&quot;;
String setRST = &quot;AT+RST\r\n&quot;;
String setCWJAP = &quot;AT+CWJAP=\&quot;DQXYFDY-105\&quot;,\&quot;dqxyfdybgs105\&quot;\r\n&quot;;  //热点wifi名字密码
String setCIPMUX = &quot;AT+CIPMUX=0\r\n&quot;;  //单连接
String setCIPSTART = &quot;AT+CIPSTART=\&quot;TCP\&quot;,\&quot;192.168.1.105\&quot;,8080\r\n&quot;; //TCP协议 中间是服务端IP（上位机）最后是连接端口
String setCIPMODE = &quot;AT+CIPMODE=1\r\n&quot;;  //透传模式
//String setCIPSEND = &quot;AT+CIPSEND\r\n&quot;;
//String setString = &quot;ID01\r\n&quot;;
//String setEnd = &quot;+++&quot;;

void setAT() {
SoftwareSerialsoftSerial(1, 0);//RX=1 TX=0
softSerial.begin(115200);
softSerial.print(setCWMODE);//将8266设置为STA模式
delay(3000);
softSerial.print(setRST);//设置完之后重启
delay(3000);
 int i;
  for(i=0;i&lt;5;i++){//循环连接wifi避免出意外
softSerial.print(setCWJAP);//8266连接路由器发出的WiFi
delay(3000);}
softSerial.print(setCIPMUX);//启动多连接
delay(3000);
softSerial.print(setCIPSTART);//通过协议、IP和端口连接服务器
delay(3000);
softSerial.print(setCIPMODE);//发送进入透传模式指令
delay(3000);
//  softSerial.print(setCIPSEND);//发送进入透传发送模式指令
//  delay(3000);
//  softSerial.print(setString);//发送数据
//  delay(3000);
//  softSerial.print(setEnd);//退出透传发送模式
//  delay(3000);
}

void suid(uint8_t setU) {
SoftwareSerialsoftSerial(1, 0);//RX=1 TX=0
softSerial.begin(115200);


softSerial.print(setU);//发送数据


}
void stopU() {
SoftwareSerialsoftSerial(1, 0);//RX=1 TX=0
softSerial.begin(115200);
  String setID=&quot;&amp;ID02&quot;; //设备ID
   String setS = &quot;\n&quot;;
  String setEnd = &quot;+++&quot;; //发送终止符合
softSerial.print(setID);//发送数据
softSerial.print(setS);
delay(1000);
softSerial.print(setEnd);//退出透传发送模式
delay(3000);
}



void setup(void) {

setAT();

nfc.begin();

  uint32_t versiondata = nfc.getFirmwareVersion();
  if (! versiondata) {
Serial.print(&quot;Didn't find PN53x board&quot;);
    while (1); // halt
  }


nfc.setPassiveActivationRetries(0xFF);


nfc.SAMConfig();

}

void loop(void) {
boolean success;
  uint8_t uid[] = { 0, 0, 0, 0, 0, 0, 0 };  // Buffer to store the returned UID
  uint8_t uidLength;                        // Length of the UID (4 or 7 bytes depending on ISO14443A card type)

  // Wait for an ISO14443A type cards (Mifare, etc.).  When one is found
  // 'uid' will be populated with the UID, and uidLength will indicate
  // if the uid is 4 bytes (Mifare Classic) or 7 bytes (Mifare Ultralight)
  success = nfc.readPassiveTargetID(PN532_MIFARE_ISO14443A, &amp;uid[0], &amp;uidLength);

  if (success) {
SoftwareSerialsoftSerial(1, 0);//RX=1 TX=0
softSerial.begin(115200);  //设置这两个通信口的波特率
     String setCIPSEND = &quot;AT+CIPSEND\r\n&quot;;  
softSerial.print(setCIPSEND);//发送进入透传发送模式指令
delay(3000);
    for (uint8_t i = 0; i&lt;uidLength; i++)
    {
      uint8_t setU = uid[i];
suid(setU);

    }
stopU();
    // Wait 1 second before continuing

  }
  else
  {
    // PN532 probably timed out waiting for a card
Serial.println(&quot;Timed out waiting for a card&quot;);
  }
}
</code></pre>
<p>Software part:<br>
Database design, Server based on Java.</p>
<p>Java server code:<br>
It is divided into three parts: Server part, multithreading part, and display database part (for the convenience of connecting with Android in the back).</p>
<p><strong>Server part</strong></p>
<pre><code>package core;
	import java.io.IOException;
	import java.net.InetAddress;
	import java.net.ServerSocket;
	import java.net.Socket;


	/*
	* 基于TCP协议的Socket通信，实现用户登陆
	* 服务器端
	*/
	public class Server {
	   public static void main(String[] args) {
		
	      try {
		Selectiagg=new Selecti();
		agg.seclet();
	         //1.创建一个服务器端Socket，即ServerSocket，指定绑定的端口，并监听此端口
	ServerSocketserverSocket=new ServerSocket(8082);
	         Socket socket=null;
	         //记录客户端的数量
	         int count=0;
	System.out.println(&quot;***服务器即将启动，等待客户端的连接***&quot;);
	         //循环监听等待客户端的连接
	         while(true){
	            //调用accept()方法开始监听，等待客户端的连接
	            socket=serverSocket.accept();
	            //创建一个新的线程
	ServerThreadserverThread=new ServerThread(socket);
	            //启动线程
	serverThread.start();

	            count++;//统计客户端的数量
	System.out.println(&quot;客户端的数量：&quot;+count);
	InetAddress address=socket.getInetAddress();
	
	System.out.println(&quot;当前客户端的IP：&quot;+address.getHostAddress());
	
					}
	
	      } catch (IOException e) {
	e.printStackTrace();
	      }
	
	   }
	
	}

</code></pre>
<p><strong>Multithreading part</strong></p>
<pre><code>package core;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.net.Socket;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.Scanner;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.text.SimpleDateFormat;

import com.utils.JdbcUtils;

/*
* 服务器线程处理类
*/
public class ServerThread extends Thread {
   // 和本线程相关的Socket
   Socket socket = null;

   public ServerThread(Socket socket) {
this.socket = socket;

   }

	Map &lt;String,Socket&gt; map=new HashMap&lt;&gt;();
	
   //线程执行的操作，响应客户端的请求
   public void run(){
InputStream is=null;
InputStreamReaderisr=null;
BufferedReaderbr=null;
OutputStreamos=null;
PrintWriter pw=null;
      try {
         //获取输入流，并读取客户端信息
         is = socket.getInputStream();
isr = new InputStreamReader(is);
br = new BufferedReader(isr);
         String info=null;

         //获取输出流，响应客户端的请求
os = socket.getOutputStream();
         pw = new PrintWriter(os);

         while((info=br.readLine())!=null){//循环读取客户端的信息
System.out.println(&quot;客户端：&quot;+info);          
String[]  strs=info.split(&quot;&amp;&quot;);
System.out.println(strs[0].toString());
System.out.println(strs[1].toString());
SimpleDateFormatsdf = new SimpleDateFormat(&quot;yyyy-MM-dd  HH:mm:ss&quot;);
            Connection conn = null;
			PreparedStatementst = null;
			System.out.println(sdf.format(new Date()));
					try {
						String sql = &quot;insert into rpass (rpass.ID_card, rpass.P_ID,rpass.datetime ) values (?,?,?)&quot;;
						conn = JdbcUtils.getConnection();
						conn.setAutoCommit(true);
						st = conn.prepareStatement(sql);
						st.setString(1,strs[0].toString() );
						st.setString(2,strs[1].toString() );
						st.setString(3,sdf.format(new Date()));
						st.executeUpdate();
					} catch (SQLException e) {
						try {
							if (conn != null) {
								conn.rollback();
							}
						} catch (SQLException e1) {
							// throw new RuntimeException(e);
						}

					} finally {
						JdbcUtils.close(conn, st, null);
					}
            //Scanner sc=new Scanner(System.in);
System.out.println(&quot;服务器反馈：收到\r&quot;);
            //String s1=sc.nextLine();
            //pw.write(s1);
pw.flush();//调用flush()方法将缓冲输出
         }
socket.shutdownInput();//关闭输入流
      } catch (IOException e) {
         // TODO Auto-generated catch block
e.printStackTrace();
}finally{
         //关闭资源
         try {
            if(pw!=null)
pw.close();
            if(os!=null)
os.close();
            if(br!=null)
br.close();
            if(isr!=null)
isr.close();
            if(is!=null)
is.close();
            if(socket!=null)
socket.close();
         } catch (IOException e) {
e.printStackTrace();
         }
      }
   }
}
</code></pre>
<p><strong>Database part</strong></p>
<pre><code>package core;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.ArrayList;

import com.google.gson.Gson;
import com.utils.JdbcUtils;

import tool.TL;

 class Selecti {

	public void seclet() {
		// TODO Auto-generated method stub
		String sql = &quot;SELECT rcard.user_name, rpass.datetime,  FROM rcard INNER JOIN rpass ON rpass.ID_card = rcard.ID_card INNER JOIN rposition ON rposition.P_ID = rpass.P_ID&quot;;
		
		
			Connection conn = null;
		PreparedStatementst = null;
			ResultSetrs = null;

			conn = JdbcUtils.getConnection();
			ArrayList&lt;TL&gt; list=new ArrayList&lt;TL&gt;(); 
			try {
				st = conn.prepareStatement(sql);
				rs = st.executeQuery();
				while (rs.next()) {
					TL toolg=new TL();
					toolg.setUser_name(rs.getString(&quot;user_name&quot;));
				   toolg.setDatetime(rs.getString(&quot;datetime&quot;));
                   list.add(toolg);
			       }
				
				} catch (Exception e) {
				
			}   
			Gsongson=new  Gson(); 
	     String str=gson.toJson(list);
	System.out.println(str);
     } 
	}
</code></pre>
<p>Implementation effect<br>
<img src="https://riddler11.github.io/post-images/1634184937995.jpg" alt="Display" loading="lazy"><br>
<img src="https://riddler11.github.io/post-images/1634185294288.jpg" alt="Display2" loading="lazy"></p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li>
<ul>
<li><a href="#this-is-project-i-did-a-long-time-ago-because-of-this-project-i-learn-a-lot-of-things-not-only-academically-but-also-the-attitude-of-dealing-with-people">This is project I did a long time ago. Because of this project, I learn a lot of things. (Not only academically, but also the attitude of dealing with people.)</a></li>
<li><a href="#i-use-esp8266-to-wirelessly-transmit-the-information-received-by-pn532">I use ESP8266 to wirelessly transmit the information received by PN532.</a></li>
</ul>
</li>
<li><a href="#about-esp8266">About ESP8266</a>
<ul>
<li><a href="#on-transmission-communication-of-several-modes-of-pn532">On transmission communication of several modes of PN532.</a></li>
<li><a href="#hardware-running-process">Hardware running process.</a></li>
</ul>
</li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">下一篇</div>
            <a href="https://riddler11.github.io/post/test/">
              <h3 class="post-title">
                How to link Bilibili Video in your article(如何在你文章中链接哔哩哔哩视频)
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  
  <a class="rss" href="https://riddler11.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
