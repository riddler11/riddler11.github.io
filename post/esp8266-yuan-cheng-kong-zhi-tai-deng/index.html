<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ESP8266远程控制台灯 | Leo&#39;s Blog</title>
<link rel="shortcut icon" href="https://riddler11.github.io/favicon.ico?v=1633796390275">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://riddler11.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="ESP8266远程控制台灯 | Leo&#39;s Blog - Atom Feed" href="https://riddler11.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="硬件
micro USB
USB母座
继电器
电阻电容若干
ESP8266-12F
CH340C
硬件电路
####USB转UART一键下载电路

####5V转3.3V电路（降压、供电）

####ESP8266-12F主控电路

###..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://riddler11.github.io">
  <img class="avatar" src="https://riddler11.github.io/images/avatar.png?v=1633796390275" alt="">
  </a>
  <h1 class="site-title">
    Leo&#39;s Blog
  </h1>
  <p class="site-description">
    It's what you do in the dark, that puts you in the light.
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          Home
        </a>
      
    
      
        <a href="/archives" class="menu">
          Archives
        </a>
      
    
      
        <a href="/tags" class="menu">
          Tags
        </a>
      
    
      
        <a href="/post/about" class="menu">
          about
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              ESP8266远程控制台灯
            </h2>
            <div class="post-info">
              <span>
                2021-10-08
              </span>
              <span>
                10 min read
              </span>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <h2 id="硬件">硬件</h2>
<p>micro USB</p>
<p>USB母座</p>
<p>继电器</p>
<p>电阻电容若干</p>
<p>ESP8266-12F</p>
<p>CH340C</p>
<h2 id="硬件电路">硬件电路</h2>
<p>####USB转UART一键下载电路<br>
<img src="https://upload-images.jianshu.io/upload_images/24469819-7af4fa842b3649e6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="CH340C的电路设计" loading="lazy"></p>
<p>####5V转3.3V电路（降压、供电）</p>
<figure data-type="image" tabindex="1"><img src="https://upload-images.jianshu.io/upload_images/24469819-9260f8db2dd30164.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5V转3.3V" loading="lazy"></figure>
<p>####ESP8266-12F主控电路</p>
<figure data-type="image" tabindex="2"><img src="https://upload-images.jianshu.io/upload_images/24469819-78cd55e6ee1d8b73.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="最小系统" loading="lazy"></figure>
<p>####key电路<br>
<img src="https://upload-images.jianshu.io/upload_images/24469819-b466c78c8baafa79.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="手动复位等，万一自动下载不工作就靠这个" loading="lazy"></p>
<p>####继电器电路<br>
此处设计为了给USB供电充足，避免供电不足灯频闪，加了个电容，利用电容充放电来提供充足电压（这是我个人的想法，不知正确否，实际测试过才行，也欢迎各位读者批评指正）<br>
<img src="https://upload-images.jianshu.io/upload_images/24469819-118c7ceaca18a6ec.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="继电器电路" loading="lazy"></p>
<p>####总电路原理图<br>
<img src="https://upload-images.jianshu.io/upload_images/24469819-5725242dadfa7caf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="总原理图" loading="lazy"></p>
<figure data-type="image" tabindex="3"><img src="https://upload-images.jianshu.io/upload_images/24469819-861d320360992db3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="PCB 3D效果图" loading="lazy"></figure>
<p>###2020.8.28翻车部分<br>
  <strong>板子到了焊接，第一块板在所有焊接完成后，发现CH340C的芯片有问题。早上单独焊接了烧写的电路CH340C，在新版上的烧写电路是没问题的，电脑也能成功识别<br>
  由于过于自信，没有多买元件，使得第一板哪里有错误难以检查，而且没有好好核对原理图，买少了元件导致没得焊三个电阻，虽然有最小系统，但是烧录固件ESP12F呈现了十分奇怪的一直闪灯，但不走进程的状态</strong><br>
<img src="https://upload-images.jianshu.io/upload_images/24469819-300b20bccdbb2214.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="左边为焊好的板，由于检查到CH340C的损坏所以把它焊下来了。右边为对比检测，下载电路是没问题的" loading="lazy"><br>
  <strong>更多分析可以观看B站同步分享的视频</strong><br>
<a href="https://www.bilibili.com/video/BV17K411K79i?pop_share=1">B站同步的分析视频</a></p>
<p>###2020.8.31成功控制台灯<br>
<a href="https://www.bilibili.com/video/BV1Ci4y1M7DL?pop_share=1">B站观看效果点击这里</a><br>
<img src="https://upload-images.jianshu.io/upload_images/24469819-8a2c5539244e3546.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="通过自己写的APP点亮台灯图片" loading="lazy"><br>
 自己设计的这块板子理论上能够控制所有采用USB 5V供电的设备</p>
<h2 id="硬件代码部分">硬件代码部分</h2>
<p>1.  先为ESP8266-12F刷入固件（可先刷AT固件，接着刷入nodemcu固件，避免出现错误）</p>
<ol start="2">
<li>接着写代码，可以用esplorer用lua写代码，或者用arduinoIDE用C语言写代码，本人用C语言比较多，且用arduinoIDE比较多因此选择arduinoIDE</li>
</ol>
<p>代码思路，先连接WIFI，连上网后连上物联网平台（这里我使用贝壳物联，进行内网穿透，使得外网发信息能够收到），接着写控制代码（这里贝壳物联有demo，再对demo进行修改）</p>
<pre><code>/*
    此文件需安装Arduino esp8266开发环境支持，环境搭建参见：http://www.bigiot.net/talk/237.html
    本程序可以用来控制两路继电器
    ESP8266烧入此程序直接，使用高低电频控制光耦继电器来控制电灯
    我的继电器默认高电频开启，所以在初始化时都初始化为低电平，play开启D5，stop关闭D5.ESP8266上的灯作为提示灯
    代码基于https://github.com/bigiot/bigiotArduino/blob/master/examples/ESP8266/kaiguan/kaiguan.ino
    上的代码进行调整，此代码可以直接烧入到nodemcu模块，分享代码希望对大家有帮助（2020.9.7）
*/

#include &lt;ESP8266WiFi.h&gt;
#include &lt;aJSON.h&gt;

//=============  此处必须修该============
String DEVICEID=&quot;***&quot;; // 你的设备编号   ==
String  APIKEY = &quot;***&quot;; // 设备密码==//贝壳物联申请一下
//=======================================
unsigned long lastCheckInTime = 0; //记录上次报到时间
const unsigned long postingInterval = 40000; // 每隔40秒向服务器报到一次

const char* ssid     = &quot;***&quot;;//无线名称
const char* password = &quot;***&quot;;//无线密码

const char* host = &quot;www.bigiot.net&quot;;
const int httpPort = 8181;

int ELed=D4;

int SW=D5;
int SW1=D6;
//int arr_len = sizeof(pins)/sizeof(pins[0]);

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  WiFi.begin(ssid, password);
  //默认输出关闭电频
  pinMode(ELed,OUTPUT);
  pinMode(SW,OUTPUT);
  pinMode(SW1,OUTPUT);
  digitalWrite(ELed,HIGH);
  digitalWrite(SW,LOW);
  digitalWrite(SW1,LOW);

  
}

WiFiClient client;

void loop() {

  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.print(&quot;.&quot;);
  }

  // Use WiFiClient class to create TCP connections
  if (!client.connected()) {
    if (!client.connect(host, httpPort)) {
      Serial.println(&quot;connection failed&quot;);
      delay(5000);
      return;
    }
  }

  if(millis() - lastCheckInTime &gt; postingInterval || lastCheckInTime==0) {
    checkIn();
  }
  
  // Read all the lines of the reply from server and print them to Serial
  if (client.available()) {
    String inputString = client.readStringUntil('\n');
    inputString.trim();
    Serial.println(inputString);
    int len = inputString.length()+1;
    if(inputString.startsWith(&quot;{&quot;) &amp;&amp; inputString.endsWith(&quot;}&quot;)){
      char jsonString[len];
      inputString.toCharArray(jsonString,len);
      aJsonObject *msg = aJson.parse(jsonString);
      processMessage(msg);
      aJson.deleteItem(msg);          
    }
  }
}

void processMessage(aJsonObject *msg){
  aJsonObject* method = aJson.getObjectItem(msg, &quot;M&quot;);
  aJsonObject* content = aJson.getObjectItem(msg, &quot;C&quot;);     
  aJsonObject* client_id = aJson.getObjectItem(msg, &quot;ID&quot;);
  if (!method) {
    return;
  }
    String M = method-&gt;valuestring;
    if(M == &quot;say&quot;){
      String C = content-&gt;valuestring;
      String F_C_ID = client_id-&gt;valuestring;
      if(C == &quot;sw1&quot;){

        digitalWrite(ELed,LOW); //ESP8266上的灯亮
        digitalWrite(SW,HIGH);//D5口通电
        sayToClient(F_C_ID,&quot;LED All on!&quot;);    
      }else if(C == &quot;stop1&quot;){

        digitalWrite(ELed,HIGH);//ESP8266上的灯灭
        digitalWrite(SW,LOW);//D5口断电
        sayToClient(F_C_ID,&quot;LED All off!&quot;); //贝壳平台可以看到这句提示   
      }else if(C==&quot;sw2&quot;){
         digitalWrite(ELed,LOW);
        digitalWrite(SW1,HIGH);//D6通电
        sayToClient(F_C_ID,&quot;SW2 ON!&quot;);
        }else if(C==&quot;stop2&quot;){
         digitalWrite(ELed,HIGH);
        digitalWrite(SW1,LOW);//D6断电
        sayToClient(F_C_ID,&quot;SW2 OFF!&quot;);
        }
        

    }
}

void checkIn() {
    String msg = &quot;{\&quot;M\&quot;:\&quot;checkin\&quot;,\&quot;ID\&quot;:\&quot;&quot; + DEVICEID + &quot;\&quot;,\&quot;K\&quot;:\&quot;&quot; + APIKEY + &quot;\&quot;}\n&quot;;
    client.print(msg);
    lastCheckInTime = millis(); 
}

void sayToClient(String client_id, String content){
  String msg = &quot;{\&quot;M\&quot;:\&quot;say\&quot;,\&quot;ID\&quot;:\&quot;&quot; + client_id + &quot;\&quot;,\&quot;C\&quot;:\&quot;&quot; + content + &quot;\&quot;}\n&quot;;
  client.print(msg);
  lastCheckInTime = millis();
}
</code></pre>
<h2 id="控制软件">控制软件</h2>
<p>自己开发个app或者使用贝壳物联提供的app<br>
这里我用HbuilderX自己开发的app，5+app。简单来说是网站式的app<br>
参考代码部分：</p>
<pre><code>//2020.9.15更新
&lt;!DOCTYPE html&gt;
&lt;html &gt;
&lt;head &gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no&quot; /&gt;
    &lt;title&gt;&lt;/title&gt;
    &lt;script src=&quot;js/mui.min.js&quot;&gt;&lt;/script&gt;
	&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;css/1.css&quot;/&gt;
    &lt;link href=&quot;css/mui.min.css&quot; rel=&quot;stylesheet&quot;/&gt;
    &lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;
      	mui.init();
    &lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
&lt;div class=&quot;abg&quot;&gt;//这里class是自己写的一个背景图片css样式
	&lt;br&gt;
	&lt;div style=&quot;margin: auto;text-align: center;font-size: x-large;color: white;font:;&quot;&gt;&lt;label&gt;宿舍台灯控制&lt;/label&gt;&lt;/div&gt;
	
	
			&lt;br&gt;
			&lt;div class=&quot;bod&quot;&gt;
			&lt;div style=&quot;display: flex;color: white;&quot;&gt;&lt;label&gt;开关1：&lt;/label&gt;
				&lt;div class=&quot;mui-switch &quot; id=&quot;mySwitch&quot;&gt;
					&lt;div class=&quot;mui-switch-handle&quot;&gt;&lt;/div&gt;
				&lt;/div&gt;
				&lt;div style=&quot;display: flex; color: white;&quot;&gt;&lt;label&gt;&amp;nbsp;&amp;nbsp;开关2：&lt;/label&gt;
					&lt;div class=&quot;mui-switch &quot; id=&quot;mySwitch1&quot;&gt;
						&lt;div class=&quot;mui-switch-handle&quot;&gt;&lt;/div&gt;
					&lt;/div&gt;
				&lt;/div&gt;
			&lt;/div&gt;
			
	
			
			
&lt;/div&gt;
	&lt;script type=&quot;text/javascript&quot;&gt;
			var ws = new WebSocket(&quot;ws://www.bigiot.net:8383&quot;);
			//var lb = document.getElementById(&quot;lb2&quot;)
			ws.onopen = function() {
				
				mui.toast(&quot;连接成功&quot;)//软件界面显示连接成功
			};
			ws.onmessage = function(evt) {
				var received_msg = evt.data;
				//lb.innerText = received_msg
				console.log(received_msg);
				var obj = JSON.parse(received_msg)
				if (obj.M == &quot;WELCOME TO BIGIOT&quot;) {
					ws.send('{&quot;M&quot;:&quot;checkin&quot;,&quot;ID&quot;:&quot;设备ID&quot;,&quot;K&quot;:&quot;APIKEY&quot;}')//发送连接设备
				}
				if(obj.M==&quot;checkinok&quot;){
					mui.toast(&quot;服务器连接成功！可以进行控制&quot;)//这里是判断贝壳物联有没返回成功连接信息
				}
				if (obj.M == &quot;ping&quot;) //判断是否收到心跳包
				{
					ws.send('{&quot;M&quot;:&quot;beat&quot;}') //发送心跳包数据
				}
			};
			document.getElementById(&quot;mySwitch&quot;).addEventListener(&quot;toggle&quot;, function(event) {
				if (event.detail.isActive) {
					mui.toast(&quot;打开开关1&quot;)
					console.log(&quot;你启动了开关&quot;);
					ws.send('{&quot;M&quot;: &quot;say&quot;,&quot;ID&quot;: &quot;D+设备ID&quot;,&quot;C&quot;: &quot;sw1&quot;,&quot;SIGN&quot;: &quot;xx3&quot;}')//D+设备ID,D代表设备。D+ID代表要发送信息到我们的esp8266设备
				} else {
					mui.toast(&quot;关闭开关1&quot;)
					ws.send('{&quot;M&quot;: &quot;say&quot;,&quot;ID&quot;: &quot;D+设备ID&quot;,&quot;C&quot;: &quot;stop1&quot;,&quot;SIGN&quot;: &quot;xx3&quot;}')//这里发送的命令要跟ESP8266的判断的命令相匹配才会产生效果
					console.log(&quot;你关闭了开关&quot;);
				}
			})
			document.getElementById(&quot;mySwitch1&quot;).addEventListener(&quot;toggle&quot;, function(event) {
				if (event.detail.isActive) {
					mui.toast(&quot;打开开关2&quot;)
					console.log(&quot;你启动了开关&quot;);
					ws.send('{&quot;M&quot;: &quot;say&quot;,&quot;ID&quot;: &quot;D+设备ID&quot;,&quot;C&quot;: &quot;sw2&quot;,&quot;SIGN&quot;: &quot;xx3&quot;}')
				} else {
					mui.toast(&quot;关闭开关2&quot;)
					ws.send('{&quot;M&quot;: &quot;say&quot;,&quot;ID&quot;: &quot;D+设备ID&quot;,&quot;C&quot;: &quot;stop2&quot;,&quot;SIGN&quot;: &quot;xx3&quot;}')
					console.log(&quot;你关闭了开关&quot;);
					
				}
			})
			
		&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>##最后附上软件界面<br>
<img src="https://upload-images.jianshu.io/upload_images/24469819-0ad4360f6346f5db.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="软件界面效果图" loading="lazy"></p>
<p>文件已开源（2020.9.15），码云gitee下载地址:https://gitee.com/riddler11/esp8266-control-desk-lamp/tree/master/</p>
<p>（2020.9.21）在运用到控制台灯上，有些灯会出现频闪的问题。初步分析是由于里面元器件会分压到最后没能达到额定电压导致不能正常工作，需要对电路进行分析计算，以解决这个问题</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E7%A1%AC%E4%BB%B6">硬件</a></li>
<li><a href="#%E7%A1%AC%E4%BB%B6%E7%94%B5%E8%B7%AF">硬件电路</a></li>
<li><a href="#%E7%A1%AC%E4%BB%B6%E4%BB%A3%E7%A0%81%E9%83%A8%E5%88%86">硬件代码部分</a></li>
<li><a href="#%E6%8E%A7%E5%88%B6%E8%BD%AF%E4%BB%B6">控制软件</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">下一篇</div>
            <a href="https://riddler11.github.io/post/ad-hui-zhi-arduinohan-yuan-li-tu-ji-zi-ji-yu-guo-de-keng/">
              <h3 class="post-title">
                AD绘制arduino，含原理图及自己遇过的坑
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  
  <a class="rss" href="https://riddler11.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
